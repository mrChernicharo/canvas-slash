<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas Slash</title>
  </head>
  <body style="background: #333; margin: 0">
    <canvas id="canvas" width="600" height="600" style="border: 1px solid #fff; margin: 0 auto"></canvas>

    <script>
      const fps = 60;
      const canvas = document.querySelector("#canvas");
      const ctx = canvas.getContext("2d");

      let mouseX = 0;
      let mouseY = 0;

      const playerRadius = 20;
      let playerAngle = 0;
      let lastAttack = Date.now();
      const attackCooldown = 200;
      const gameStartTimestamp = Date.now();
      let slashGen = slashGenerator(gameStartTimestamp);

      setupEventListeners();

      main();

      function main() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawWorldLines();
        drawMouse();
        playerAngle = calculatePlayerAngle(canvas.width / 2, canvas.height / 2, mouseX, mouseY);
        drawPlayer(playerAngle);
        handlePlayerAttacks();

        setTimeout(main, 1000 / fps);
      }

      function setupEventListeners() {
        window.addEventListener("mousemove", (e) => {
          mouseX = e.offsetX;
          mouseY = e.offsetY;
        });

        window.addEventListener("click", (e) => {
          if (Date.now() - gameStartTimestamp > attackCooldown && Date.now() - lastAttack > attackCooldown) {
            lastAttack = Date.now();
            console.log("attack", lastAttack);
          }
        });
      }

      function drawWorldLines() {
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, 0);
        ctx.lineTo(canvas.width / 2, canvas.height);
        ctx.strokeStyle = "#00f";
        ctx.stroke();
        ctx.closePath();

        ctx.beginPath();
        ctx.moveTo(0, canvas.height / 2);
        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
        ctx.closePath();
      }

      function drawMouse() {
        ctx.strokeStyle = "#0f0";
        ctx.beginPath();
        ctx.arc(mouseX, mouseY, 8, 0, Math.PI * 2);
        ctx.stroke();
        ctx.closePath();

        // ctx.beginPath();
        // ctx.moveTo(canvas.width / 2, canvas.height / 2);
        // ctx.lineTo(mouseX, mouseY);
        // ctx.stroke();
        // ctx.closePath();
      }

      function drawPlayer(angle) {
        ctx.translate(canvas.width / 2, canvas.height / 2);

        ctx.rotate(angle);

        ctx.beginPath();
        ctx.arc(0, 0, playerRadius, 0, Math.PI * 2);
        ctx.strokeStyle = "#fff";
        ctx.stroke();
        ctx.closePath();

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(0, -20);
        ctx.stroke();
        ctx.closePath();

        ctx.rotate(-angle);
        ctx.translate(-canvas.width / 2, -canvas.height / 2);
      }

      function calculatePlayerAngle() {
        const cx = canvas.width / 2,
          cy = canvas.height / 2;

        const dy = mouseY - cy;
        const dx = mouseX - cx;
        const theta = Math.atan2(dy, dx) + Math.PI * 0.5; // range (-PI, PI]

        return theta;
      }

      function handlePlayerAttacks() {
        // ongoing attack
        const isAttacking =
          Date.now() - gameStartTimestamp > attackCooldown && Date.now() - lastAttack < attackCooldown;
        if (isAttacking) {
          drawSlash();
        } else {
          slashGen = slashGenerator(Date.now(), playerAngle);
        }
      }

      function* slashGenerator(slashTimestamp, angle) {
        const slashOverflow = 0.2;
        while (Date.now() - slashTimestamp <= attackCooldown) {
          percentage = slashOverflow + (Date.now() - slashTimestamp) / attackCooldown;
          yield [percentage, angle];
        }
        return [percentage, angle];
      }

      function drawSlash() {
        const slashRadius = playerRadius * 2;
        const [slashPercentage, angle] = slashGen.next().value;
        const startAngle = Math.PI + angle;
        const targetAngle = Math.PI * 2 + angle;
        const angleDiff = targetAngle - startAngle;
        const endAngle = startAngle + angleDiff * slashPercentage;

        ctx.beginPath();
        ctx.arc(canvas.width / 2, canvas.height / 2, slashRadius, startAngle, endAngle);
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 10;
        ctx.stroke();
        ctx.closePath();

        ctx.lineWidth = 1;
      }
    </script>
  </body>
</html>
